<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Topotrek PMTiles Viewer (Local Test)</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@4.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.1.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@2.10.0/dist/index.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .instructions {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            font-family: sans-serif;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div class="instructions">
    <strong>How to Test Locally:</strong>
    <ol>
        <li>Open a terminal in your project's root directory (the `topotrek-pipeline` folder).</li>
        <li>Run this command: <br><code>python3 -m http.server</code></li>
        <li>Open your web browser and go to:<br><strong>http://localhost:8000/index.html</strong></li>
    </ol>
    <p>This serves your project folder over HTTP, allowing the map to access the local PMTiles file.</p>
</div>

<div id="map"></div>

<script>
    const relativeBasemapUrl = '/data/us-northeast-osm.pmtiles';

    // FIX: Construct a full, absolute URL from the relative path.
    // This resolves ambiguity and prevents the "callback is not a function" error.
    const absoluteBasemapUrl = new URL(relativeBasemapUrl, window.location.href).href;

    // Initialize the PMTiles protocol for MapLibre
    let protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", protocol.tile);

    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: {
                'basemap-source': {
                    type: 'vector',
                    // The URL now uses the full, absolute path.
                    url: `pmtiles://${absoluteBasemapUrl}`,
                    attribution: '© OpenMapTiles © OpenStreetMap contributors'
                }
            },
            layers: [
                {
                    'id': 'background',
                    'type': 'background',
                    'paint': { 'background-color': '#f8f4f0' }
                },
                {
                    'id': 'water',
                    'type': 'fill',
                    'source': 'basemap-source',
                    'source-layer': 'water',
                    'paint': { 'fill-color': '#a0c8f0' }
                },
                {
                    'id': 'roads',
                    'type': 'line',
                    'source': 'basemap-source',
                    'source-layer': 'transportation',
                    'paint': { 'line-color': '#999' }
                }
            ]
        },
        center: [-73.985, 40.748], // Centered on NYC
        zoom: 9,
        pitch: 0,
        bearing: -20
    });

    // Add navigation controls
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

</script>
</body>
</html>
